---
description: uniCloudå¼€å‘è§„èŒƒ - ä»…é€šè¿‡adminäº‘å¯¹è±¡æ“ä½œæ•°æ®åº“
globs: *.vue,*.ts,*.js
alwaysApply: false
---
# uniCloud å¼€å‘è§„èŒƒ

## æ ¸å¿ƒåŸåˆ™ï¼šä¸¥æ ¼åˆ†ç¦»æ•°æ®è®¿é—®å±‚

### ğŸš« ä¸¥ç¦è¡Œä¸º
- **ç¦æ­¢åœ¨uni-appé¡¹ç›®ä¸­ç›´æ¥æ“ä½œæ•°æ®åº“**
- **ç¦æ­¢åœ¨uni-appä¸­ä½¿ç”¨uniCloud.database()è¿›è¡ŒCRUDæ“ä½œ**
- **ç¦æ­¢ç»•è¿‡adminé¡¹ç›®ç›´æ¥è®¿é—®æ•°æ®åº“**
- **ç¦æ­¢åœ¨uni-appä¸­åˆ›å»ºäº‘å‡½æ•°è¿›è¡Œæ•°æ®åº“æ“ä½œ**

### âœ… å¼ºåˆ¶è¦æ±‚
- **å¿…é¡»é€šè¿‡adminé¡¹ç›®å®šä¹‰çš„äº‘å¯¹è±¡è¿›è¡Œæ‰€æœ‰æ•°æ®åº“æ“ä½œ**
- **æ‰€æœ‰æ•°æ®è®¿é—®é€»è¾‘é›†ä¸­åœ¨adminé¡¹ç›®ç®¡ç†**
- **uni-appä»…ä½œä¸ºå‰ç«¯å±•ç¤ºå±‚ï¼Œè°ƒç”¨äº‘å¯¹è±¡æ¥å£**

## æ­£ç¡®çš„å¼€å‘æ¨¡å¼

### 1. Adminé¡¹ç›® - æ•°æ®è®¿é—®å±‚
```js
// admin/uniCloud-aliyun/cloudfunctions/user-center/index.obj.js
module.exports = {
  // è·å–ç”¨æˆ·åˆ—è¡¨
  async getUserList(params) {
    const db = uniCloud.database()
    const { pageNum = 1, pageSize = 10, keyword } = params
    
    // æƒé™éªŒè¯
    if (!this.getUniIdToken()) {
      throw new Error('æœªç™»å½•')
    }
    
    // æ•°æ®åº“æŸ¥è¯¢
    const query = db.collection('users')
    if (keyword) {
      query.where({
        name: new RegExp(keyword, 'i')
      })
    }
    
    const result = await query
      .skip((pageNum - 1) * pageSize)
      .limit(pageSize)
      .get()
    
    return {
      code: 0,
      data: result.data,
      total: result.affectedDocs
    }
  },
  
  // åˆ›å»ºç”¨æˆ·
  async createUser(userData) {
    const db = uniCloud.database()
    
    // æƒé™éªŒè¯ - ä»…ç®¡ç†å‘˜å¯åˆ›å»º
    const userInfo = this.getUniIdToken()
    if (!userInfo || userInfo.role !== 'admin') {
      throw new Error('æƒé™ä¸è¶³')
    }
    
    // æ•°æ®éªŒè¯
    if (!userData.name || !userData.email) {
      throw new Error('ç”¨æˆ·åå’Œé‚®ç®±ä¸ºå¿…å¡«é¡¹')
    }
    
    // æ•°æ®åº“æ“ä½œ
    const result = await db.collection('users').add({
      ...userData,
      createTime: Date.now(),
      updateTime: Date.now()
    })
    
    return {
      code: 0,
      data: { id: result.id },
      message: 'ç”¨æˆ·åˆ›å»ºæˆåŠŸ'
    }
  },
  
  // æ›´æ–°ç”¨æˆ·
  async updateUser(userId, updateData) {
    const db = uniCloud.database()
    
    // æƒé™éªŒè¯
    const userInfo = this.getUniIdToken()
    if (!userInfo) {
      throw new Error('æœªç™»å½•')
    }
    
    // æ•°æ®åº“æ“ä½œ
    const result = await db.collection('users').doc(userId).update({
      ...updateData,
      updateTime: Date.now()
    })
    
    return {
      code: 0,
      message: 'æ›´æ–°æˆåŠŸ'
    }
  },
  
  // åˆ é™¤ç”¨æˆ·
  async deleteUser(userId) {
    const db = uniCloud.database()
    
    // æƒé™éªŒè¯ - ä»…ç®¡ç†å‘˜å¯åˆ é™¤
    const userInfo = this.getUniIdToken()
    if (!userInfo || userInfo.role !== 'admin') {
      throw new Error('æƒé™ä¸è¶³')
    }
    
    // æ•°æ®åº“æ“ä½œ
    await db.collection('users').doc(userId).remove()
    
    return {
      code: 0,
      message: 'åˆ é™¤æˆåŠŸ'
    }
  }
}
```

### 2. uni-appé¡¹ç›® - å‰ç«¯è°ƒç”¨å±‚
```vue
<template>
  <view class="user-management">
    <uni-list>
      <uni-list-item 
        v-for="user in userList" 
        :key="user._id"
        :title="user.name"
        :note="user.email"
        @click="editUser(user)"
      />
    </uni-list>
    
    <uni-fab 
      :pattern="fabPattern"
      @trigger="createUser"
    />
  </view>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue'

// ç±»å‹å®šä¹‰
interface User {
  _id: string
  name: string
  email: string
  createTime: number
}

interface ApiResponse<T> {
  code: number
  data: T
  message?: string
  total?: number
}

// å“åº”å¼æ•°æ®
const userList = ref<User[]>([])
const loading = ref(false)

// âœ… æ­£ç¡®ï¼šé€šè¿‡äº‘å¯¹è±¡è°ƒç”¨æ•°æ®æ¥å£
const getUserList = async (params: {
  pageNum?: number
  pageSize?: number
  keyword?: string
} = {}) => {
  try {
    loading.value = true
    
    // è°ƒç”¨adminé¡¹ç›®çš„äº‘å¯¹è±¡
    const result = await uniCloud.callFunction({
      name: 'user-center',
      data: {
        action: 'getUserList',
        params
      }
    }) as { result: ApiResponse<User[]> }
    
    if (result.result.code === 0) {
      userList.value = result.result.data
    } else {
      uni.showToast({
        title: result.result.message || 'è·å–ç”¨æˆ·åˆ—è¡¨å¤±è´¥',
        icon: 'error'
      })
    }
  } catch (error) {
    console.error('è·å–ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error)
    uni.showToast({
      title: 'ç½‘ç»œé”™è¯¯',
      icon: 'error'
    })
  } finally {
    loading.value = false
  }
}

// âœ… æ­£ç¡®ï¼šåˆ›å»ºç”¨æˆ·é€šè¿‡äº‘å¯¹è±¡
const createUser = async () => {
  try {
    const userData = {
      name: 'æ–°ç”¨æˆ·',
      email: 'new@example.com'
    }
    
    // è°ƒç”¨adminé¡¹ç›®çš„äº‘å¯¹è±¡
    const result = await uniCloud.callFunction({
      name: 'user-center',
      data: {
        action: 'createUser',
        userData
      }
    }) as { result: ApiResponse<{ id: string }> }
    
    if (result.result.code === 0) {
      uni.showToast({
        title: 'åˆ›å»ºæˆåŠŸ',
        icon: 'success'
      })
      // åˆ·æ–°åˆ—è¡¨
      await getUserList()
    } else {
      uni.showToast({
        title: result.result.message || 'åˆ›å»ºå¤±è´¥',
        icon: 'error'
      })
    }
  } catch (error) {
    console.error('åˆ›å»ºç”¨æˆ·å¤±è´¥:', error)
    uni.showToast({
      title: 'åˆ›å»ºå¤±è´¥',
      icon: 'error'
    })
  }
}

// âœ… æ­£ç¡®ï¼šæ›´æ–°ç”¨æˆ·é€šè¿‡äº‘å¯¹è±¡
const editUser = async (user: User) => {
  try {
    const updateData = {
      name: user.name + '_updated'
    }
    
    // è°ƒç”¨adminé¡¹ç›®çš„äº‘å¯¹è±¡
    const result = await uniCloud.callFunction({
      name: 'user-center',
      data: {
        action: 'updateUser',
        userId: user._id,
        updateData
      }
    }) as { result: ApiResponse<void> }
    
    if (result.result.code === 0) {
      uni.showToast({
        title: 'æ›´æ–°æˆåŠŸ',
        icon: 'success'
      })
      await getUserList()
    }
  } catch (error) {
    console.error('æ›´æ–°ç”¨æˆ·å¤±è´¥:', error)
  }
}

onMounted(() => {
  getUserList()
})
</script>
```

## âŒ é”™è¯¯ç¤ºä¾‹ - ç¦æ­¢ä»¥ä¸‹åšæ³•

### 1. ç¦æ­¢åœ¨uni-appä¸­ç›´æ¥æ“ä½œæ•°æ®åº“
```typescript
// âŒ ä¸¥ç¦ï¼šç›´æ¥åœ¨uni-appä¸­æ“ä½œæ•°æ®åº“
const getUserList = async () => {
  // è¿™æ˜¯é”™è¯¯çš„åšæ³•ï¼
  const db = uniCloud.database()
  const result = await db.collection('users').get()
  return result.data
}

// âŒ ä¸¥ç¦ï¼šåœ¨uni-appä¸­æ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢
const searchUsers = async (keyword: string) => {
  // è¿™æ˜¯é”™è¯¯çš„åšæ³•ï¼
  const db = uniCloud.database()
  const result = await db.collection('users')
    .where({
      name: new RegExp(keyword, 'i')
    })
    .get()
  return result.data
}
```

### 2. ç¦æ­¢åœ¨uni-appä¸­åˆ›å»ºæ•°æ®åº“æ“ä½œäº‘å‡½æ•°
```javascript
// âŒ ä¸¥ç¦ï¼šåœ¨uni-appé¡¹ç›®ä¸­åˆ›å»ºæ­¤ç±»äº‘å‡½æ•°
// uniCloud-aliyun/cloudfunctions/user-crud/index.js
exports.main = async (event, context) => {
  const db = uniCloud.database()
  // è¿™ç§åšæ³•æ˜¯è¢«ç¦æ­¢çš„ï¼
  return await db.collection('users').get()
}
```

## æ¶æ„ä¼˜åŠ¿

### 1. å®‰å…¨æ€§å¢å¼º
- **æƒé™é›†ä¸­ç®¡ç†**ï¼šæ‰€æœ‰æ•°æ®è®¿é—®æƒé™åœ¨adminé¡¹ç›®ç»Ÿä¸€æ§åˆ¶
- **é˜²æ­¢SQLæ³¨å…¥**ï¼šæ•°æ®éªŒè¯å’Œè¿‡æ»¤é›†ä¸­åœ¨æœåŠ¡ç«¯
- **APIç»Ÿä¸€éªŒè¯**ï¼šé¿å…å‰ç«¯ç»•è¿‡å®‰å…¨æ£€æŸ¥

### 2. ä»£ç ç»´æŠ¤æ€§
- **é€»è¾‘é›†ä¸­**ï¼šæ‰€æœ‰ä¸šåŠ¡é€»è¾‘åœ¨adminé¡¹ç›®ä¸­ç»´æŠ¤
- **æ¥å£æ ‡å‡†åŒ–**ï¼šç»Ÿä¸€çš„APIè°ƒç”¨æ–¹å¼å’Œè¿”å›æ ¼å¼
- **èŒè´£åˆ†ç¦»**ï¼šå‰ç«¯ä¸“æ³¨UIå±•ç¤ºï¼Œåç«¯ä¸“æ³¨æ•°æ®å¤„ç†

### 3. å›¢é˜Ÿåä½œ
- **åˆ†å·¥æ˜ç¡®**ï¼šå‰ç«¯å¼€å‘è€…ä¸“æ³¨UIï¼Œåç«¯å¼€å‘è€…ä¸“æ³¨æ•°æ®é€»è¾‘
- **ç‰ˆæœ¬æ§åˆ¶**ï¼šæ•°æ®åº“schemaå˜æ›´é€šè¿‡adminé¡¹ç›®ç»Ÿä¸€ç®¡ç†
- **APIæ–‡æ¡£**ï¼šäº‘å¯¹è±¡æ¥å£ä½œä¸ºæ ‡å‡†APIæ–‡æ¡£

## TypeScriptç±»å‹å®šä¹‰

### 1. äº‘å¯¹è±¡è°ƒç”¨ç±»å‹
```typescript
// types/unicloud.ts
export interface CloudObjectResponse<T = any> {
  result: {
    code: number
    data: T
    message?: string
    total?: number
  }
}

export interface CloudObjectParams {
  name: string
  data: {
    action: string
    [key: string]: any
  }
}

// ç”¨æˆ·ç›¸å…³ç±»å‹
export interface User {
  _id: string
  name: string
  email: string
  avatar?: string
  role?: string
  createTime: number
  updateTime: number
}

export interface UserListParams {
  pageNum?: number
  pageSize?: number
  keyword?: string
  role?: string
}
```

### 2. äº‘å¯¹è±¡è°ƒç”¨å°è£…
```typescript
// utils/cloud-api.ts
class CloudAPI {
  // å°è£…äº‘å¯¹è±¡è°ƒç”¨
  private async callCloudObject<T>(
    objectName: string, 
    action: string, 
    params: any = {}
  ): Promise<T> {
    try {
      const result = await uniCloud.callFunction({
        name: objectName,
        data: {
          action,
          ...params
        }
      }) as CloudObjectResponse<T>
      
      if (result.result.code !== 0) {
        throw new Error(result.result.message || 'è¯·æ±‚å¤±è´¥')
      }
      
      return result.result.data
    } catch (error) {
      console.error(`äº‘å¯¹è±¡è°ƒç”¨å¤±è´¥ ${objectName}.${action}:`, error)
      throw error
    }
  }
  
  // ç”¨æˆ·ç›¸å…³API
  async getUserList(params: UserListParams): Promise<User[]> {
    return this.callCloudObject<User[]>('user-center', 'getUserList', { params })
  }
  
  async createUser(userData: Partial<User>): Promise<{ id: string }> {
    return this.callCloudObject('user-center', 'createUser', { userData })
  }
  
  async updateUser(userId: string, updateData: Partial<User>): Promise<void> {
    return this.callCloudObject('user-center', 'updateUser', { userId, updateData })
  }
  
  async deleteUser(userId: string): Promise<void> {
    return this.callCloudObject('user-center', 'deleteUser', { userId })
  }
}

export const cloudAPI = new CloudAPI()
```

## é”™è¯¯å¤„ç†è§„èŒƒ

### 1. äº‘å¯¹è±¡é”™è¯¯å¤„ç†
```typescript
// åœ¨ç»„åˆå¼APIä¸­ä½¿ç”¨
const useUserAPI = () => {
  const loading = ref(false)
  const error = ref<string>('')
  
  const handleCloudError = (err: any) => {
    console.error('äº‘å¯¹è±¡è°ƒç”¨å¤±è´¥:', err)
    error.value = err.message || 'æ“ä½œå¤±è´¥'
    uni.showToast({
      title: error.value,
      icon: 'error'
    })
  }
  
  const getUserList = async (params: UserListParams) => {
    try {
      loading.value = true
      error.value = ''
      return await cloudAPI.getUserList(params)
    } catch (err) {
      handleCloudError(err)
      return []
    } finally {
      loading.value = false
    }
  }
  
  return {
    loading: readonly(loading),
    error: readonly(error),
    getUserList
  }
}
```

## å¼€å‘æµç¨‹è§„èŒƒ

### 1. éœ€æ±‚åˆ†æé˜¶æ®µ
- å‰ç«¯å¼€å‘è€…æå‡ºæ•°æ®éœ€æ±‚
- åç«¯å¼€å‘è€…åœ¨adminé¡¹ç›®ä¸­è®¾è®¡äº‘å¯¹è±¡æ¥å£
- ç¡®å®šæ¥å£å‚æ•°ã€è¿”å›å€¼æ ¼å¼å’Œé”™è¯¯å¤„ç†

### 2. æ¥å£å¼€å‘é˜¶æ®µ
- åç«¯åœ¨adminé¡¹ç›®ä¸­å®ç°äº‘å¯¹è±¡æ–¹æ³•
- åŒ…å«æƒé™éªŒè¯ã€æ•°æ®éªŒè¯ã€ä¸šåŠ¡é€»è¾‘
- æä¾›æ¥å£æ–‡æ¡£å’Œæµ‹è¯•ç”¨ä¾‹

### 3. å‰ç«¯è°ƒç”¨é˜¶æ®µ
- å‰ç«¯é€šè¿‡uniCloud.callFunctionè°ƒç”¨äº‘å¯¹è±¡
- ä½¿ç”¨TypeScriptç±»å‹ç¡®ä¿ç±»å‹å®‰å…¨
- å®ç°ç»Ÿä¸€çš„é”™è¯¯å¤„ç†å’ŒåŠ è½½çŠ¶æ€

### 4. æµ‹è¯•éƒ¨ç½²é˜¶æ®µ
- adminé¡¹ç›®ä¼˜å…ˆéƒ¨ç½²å’Œæµ‹è¯•
- å‰ç«¯åŸºäºç¨³å®šçš„äº‘å¯¹è±¡æ¥å£è¿›è¡Œå¼€å‘
- ç¡®ä¿æƒé™æ§åˆ¶å’Œæ•°æ®å®‰å…¨

é€šè¿‡ä¸¥æ ¼éµå¾ªè¿™å¥—è§„èŒƒï¼Œç¡®ä¿uniCloudé¡¹ç›®çš„å®‰å…¨æ€§ã€å¯ç»´æŠ¤æ€§å’Œå›¢é˜Ÿåä½œæ•ˆç‡ã€‚